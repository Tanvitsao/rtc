<!DOCTYPE html>
<html>

<head>
	<title>南山產物視訊服務</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="./plugin/bootstrap-5.1.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="./css/main.css" />
</head>

<body>
	<div class="header">
		<img src="./assets/image/logo.jpg" height="40px" width="200px" style="margin-bottom: 10px;" alt="">
		<h3 class="video-title">視訊服務</h3>
		<div class="status ms-auto">
			<span id="customerState" class="me-4">客戶：未上線</span>
			<span id="agentState">客服人員：未上線</span>
		</div>
	</div>
	<div class="gradient-bar"></div>
	<div class="content-container center">
		<div class="inner-container">
			<!-- 尚未加入的畫面 -->
			<div id="enter-view" class="video-zone center">
				<div id="circle" class="center"></div>
			</div>
			<!-- 等待對方的畫面 -->
			<!-- <div id="wait-view" class="video-zone center"></div> -->
			<!-- 視訊畫面 -->
			<div id="videos" class="video-zone active">
				<video id="remoteVideo" autoplay playsinline class="active"></video>
				<video id="localVideo" autoplay playsinline class="active"></video>
			</div>
		</div>
		<div class="btn-group center">
			<button id="join-button" onclick="onStartClick()">開始</button>
			<button id="record-button" onclick="onRecordClick()">錄製</button>
			<div id="close-button" onclick="onStopClick()">
				<img src="./assets/image/close.svg" width="50" alt="">
			</div>
		</div>
	</div>




	<script src="./js/sockjs.min.js"></script>
	<script src="./plugin/bootstrap-5.1.0/js/bootstrap.min.js"></script>
	<script src="./js/adapter.js"></script>
	<script>
		/* web socket */
		let wsc;
		/* url prarm */
		let _myParam = location.search.split('room=')[1];
		/* 本地流 */
		let localstream;
		let remotestream;
		/* RTCPeerConnection */
		let pc;
		/* iceServer */
		const iceServer = {
			iceServers: [{
				"urls": "stun:stun.l.google.com:19302" // Google's public STUN server
			}]
		};
		/* 本地/遠端視訊 element */
		const localVideoEl = document.getElementById('localVideo');
		const remoteVideoEl = document.getElementById('remoteVideo');
		/* 錄音錄影 */
		let localRecorder;
		let remoteRecorder;

		// window 初始化
		window.onload = function () {
			getIdentity();
		}

		// 判斷身分為客服人員或客戶
		function getIdentity() {
			if (_myParam.indexOf('@') > -1) { // Agent
				document.getElementById("circle").innerText = '客服人員';
			} else if (_myParam.indexOf('$') > -1) { // Customer
				document.getElementById("circle").innerText = '客戶';
			}
		}

		/**
		 * 建立 web socket 連線
		 * 因一連線就會上線，所以在點選開始之後再建立連線
		 */
		function createWebSocketConnection() {
			document.getElementById("enter-view").style.display = 'none';
			document.getElementById('join-button').style.display = "none";
			document.getElementById("videos").style.display = 'block';
			document.getElementById("close-button").style.display = 'block';

			if ("WebSocket" in window) {
				// wsc = new WebSocket("wss://lab.easontech.com.tw:4431/CSMWebAPI/websocket?serno=" + _myParam);
				// wsc = new WebSocket("wss://lab.easontech.com.tw:8443/rtc/rtc/" + _myParam);
				wsc = new SockJS("https://lab.easontech.com.tw:8443/rtc/rtc/" + _myParam);
				wsc.onopen = function (event) {
					console.log("WebSocket connected to server");
				};

				wsc.onmessage = function (event) {
					try {

						const message = JSON.parse(event.data);
						if (message.State && message.State.indexOf('Online') > -1) {
							console.log("State::" + event.data);
							document.getElementById("enter-view").style.display = 'none';
							document.getElementById('join-button').style.display = "none";
							document.getElementById("videos").style.display = 'block';
							document.getElementById("close-button").style.display = 'block';

							if (message.Serno.indexOf('@') > -1) {	//Agent
								// document.getElementById("wait-view").innerText = '等待客戶上線中...';

								if (message.State.indexOf('CT') > -1) {
									document.getElementById("customerState").innerText = '客戶：已上線';
									startWebRTC();
								}
								else {
									// 取得攝影機、麥克風權限
									createMedia();
									document.getElementById("agentState").innerText = '客服人員：已上線';
									document.getElementById("record-button").style.display = 'block';
								}
							} else if (message.Serno.indexOf('$') > -1) { //Customer
								// document.getElementById("wait-view").innerText = '等待客服人員上線中...';

								if (message.State.indexOf('CS') > -1) {
									document.getElementById("agentState").innerText = '客服人員：已上線';
									startWebRTC();
								}
								else {
									// 取得攝影機、麥克風權限
									createMedia();
									document.getElementById("customerState").innerText = '客戶：已上線';
								}
							}
						}
						else if (message.sdp) {
							console.log("Sdp::" + event.data);
							pc.setRemoteDescription(new RTCSessionDescription(message.sdp), function () {
								if (pc.remoteDescription.type == "offer") {
									pc.createAnswer(localDescCreated, logError);
								}
							}, logError);
						} else if (message.candidate) {
							console.log("Candidate::" + event.data);
							pc.addIceCandidate(new RTCIceCandidate(message.candidate));
						}
					}
					catch
					{ }
				};
			}
		}

		// 結束 web socket 連線
		function closeWebSocketConnection() {
			wsc.close();
		}

		// 點選開始
		function onStartClick() {
			createWebSocketConnection();
			setupPeerConnection();
		}

		// 初始化影像/聲音
		async function createMedia() {
			// 儲存本地流到全域
			localstream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
			if (!localVideoEl.srcObject && localstream) {
				localVideoEl.srcObject = localstream;
				console.log('本地端視訊！');
			}


			addLocalStream();
		};

		// 增加本地流
		function addLocalStream() {
			// pc.addStream(localstream);
			localstream.getTracks().forEach(track => pc.addTrack(track, localstream));
		};

		function setupPeerConnection() {
			createPeerConnection();
			// startWebRTC();
		}

		// 呼叫 startWebRTC() 開始建立連線
		async function startWebRTC() {
			console.log(pc);
			pc.onicecandidate = function (event) {
				if (event.candidate) {
					//send the candidate to remote peer
					wsc.send(JSON.stringify({ "candidate": event.candidate }));
				}
			};

			pc.oniceconnectionstatechange = function (event) {
				console.log('ICE 伺服器狀態變更 => ', event.target.iceConnectionState);
			}

			// let the "negotiationneeded" event trigger offer generation
			pc.onnegotiationneeded = function () {
				pc.createOffer(localDescCreated, logError);
			}

			// once remote stream arrives, show it in the remote video element
			pc.ontrack = function (event) {
				console.log('remote: ', event);
				if (!remoteVideoEl.srcObject && event.streams) {
					remoteVideoEl.srcObject = event.streams[0];
					remotestream = event.streams[0];
					console.log('接收流並顯示於遠端視訊！', event);
				}
			};
		}

		// 建立 P2P 連接
		function createPeerConnection() {
			if (pc) {
				pc.close();
				pc = null;
			}
			pc = new RTCPeerConnection(iceServer);
			console.log(pc);
		};

		// 關閉 P2P 連接
		function closePeerConnection() {
			// 暫停video播放，並將儲存在src裡的 MediaStreamTracks 依序停止
			if (localVideoEl.srcObject) {
				localVideoEl.pause();
				localVideoEl.srcObject.getTracks().forEach((track) => {
					track.stop();
				});
			}
			if (pc) {
				pc.close();
				pc = null;
				localstream = null;
			}
		};

		function onRecordClick() {
			startRecorder();
		}

		// 啟動錄音錄影
		function startRecorder() {
			// const tracks = [...localstream.getTracks(), ...remotestream.getTracks()];

			/* 建立本地端 mediaRecorder 物件 */
			localRecorder = new MediaRecorder(new MediaStream(localstream));
			localRecorder.start();
			// 訂閱 MediaRecorder，在結束錄影後回傳檔案
			localRecorder.ondataavailable = function (event) {
				console.log(event);
				const recordVideo = new Blob([event.data], { 'type': 'video' });
				const url = URL.createObjectURL(recordVideo);
				const downloadLink = document.createElement('a');
				downloadLink.href = url; // url
				downloadLink.download = 'local_video.mp4'; // 檔名
				document.body.appendChild(downloadLink);
				downloadLink.click();
				document.body.removeChild(downloadLink);
			}


			/* 建立遠端 mediaRecorder 物件 */
			remoteRecorder = new MediaRecorder(new MediaStream(remotestream));
			remoteRecorder.start();
			// 訂閱 MediaRecorder，在結束錄影後回傳檔案
			remoteRecorder.ondataavailable = function (event) {
				console.log(event);
				const recordVideo = new Blob([event.data], { 'type': 'video' });
				const url = URL.createObjectURL(recordVideo);
				const downloadLink = document.createElement('a');
				downloadLink.href = url; // url
				downloadLink.download = 'remote_video.mp4'; // 檔名
				document.body.appendChild(downloadLink);
				downloadLink.click();
				document.body.removeChild(downloadLink);
			}




			// const tracks = [...localstream.getTracks(), ...remotestream.getTracks()];

			// const stream = new MediaStream(tracks);
			/* 建立 mediaRecorder 物件 */
			// recorder = new MediaRecorder(stream);
			// recorder.start();
			// // 訂閱 MediaRecorder，在結束錄影後回傳檔案
			// recorder.ondataavailable = function (event) {
			// 	console.log(event);
			// 	const recordVideo = new Blob([event.data], { 'type': 'video' });
			// 	const url = URL.createObjectURL(recordVideo);
			// 	const downloadLink = document.createElement('a');
			// 	downloadLink.href = url; // url
			// 	downloadLink.download = 'video.mp4'; // 檔名
			// 	document.body.appendChild(downloadLink);
			// 	downloadLink.click();
			// 	document.body.removeChild(downloadLink);
			// }
		}

		// 結束錄音錄影並下載檔案
		function stopRecorder() {
			if (localRecorder) {
				localRecorder.stop();
			}
			if (remoteRecorder) {
				remoteRecorder.stop();
			}
		}

		function onStopClick() {
			stopRecorder();
			closeWebSocketConnection();
			closePeerConnection();

			document.getElementById("videos").style.display = 'none';
			document.getElementById("enter-view").style.display = 'flex';
			// document.getElementById("wait-view").style.display = 'none';
			document.getElementById('join-button').style.display = "block";
			document.getElementById("close-button").style.display = 'none';
			document.getElementById("record-button").style.display = 'none';
			if (_myParam.indexOf('@') > -1) { // Agent
				document.getElementById("agentState").innerText = '客服人員：未上線';
			} else if (_myParam.indexOf('$') > -1) { // Customer
				document.getElementById("customerState").innerText = '客戶：未上線';
			}
		}

		function localDescCreated(desc) {
			pc.setLocalDescription(desc, function () {
				wsc.send(JSON.stringify({ "sdp": pc.localDescription }));
			}, logError);
		}

		function logError(error) {
			console.log(error.name + ": " + error.message);
		}

	</script>
</body>

</html>